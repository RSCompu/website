<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyperspace Monitoring System</title>
    <style>
        :root {
            /* Base Hues for reference (used for secondary, non-shifting elements) */
            --static-red: #ff0055;
            --static-amber: #ffbf00;
            
            /* Dynamic HSL components - Controlled by JS update */
            --dynamic-h: 298; /* Default starting hue (Magenta) */
            --dynamic-s: 99%;
            --dynamic-l: 53%;
            
            /* Primary color now shifts (Magenta/Purple -> Spectrum) */
            --neon-primary: hsl(var(--dynamic-h), var(--dynamic-s), var(--dynamic-l)); 
            
            /* Secondary accent color (Cyan -> Spectrum) */
            --neon-secondary: hsl(calc(var(--dynamic-h) + 180), 100%, 50%); 
            
            --bg-color: #050505;
            --glass-bg: rgba(20, 5, 20, 0.75); 
            --glass-border: hsla(var(--dynamic-h), var(--dynamic-s), var(--dynamic-l), 0.3); /* Shifting border */
            --neon-dark: hsl(var(--dynamic-h), 50%, 10%); 
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            color: var(--neon-primary); /* Primary theme color */
            height: 100vh;
            width: 100vw;
        }

        /* Canvas container */
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* Vignette and scanlines overlay */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            /* Subtly tint the vignette with the current hue */
            background: radial-gradient(circle, transparent 50%, var(--neon-dark) 150%);
            pointer-events: none;
        }

        .scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            pointer-events: none;
            opacity: 0.3;
        }

        /* Control Panel */
        #controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 320px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 20px;
            z-index: 10;
            box-shadow: 0 0 20px hsla(var(--dynamic-h), var(--dynamic-s), var(--dynamic-l), 0.1); 
            transition: transform 0.3s ease;
        }

        .control-header h3 {
            color: var(--neon-secondary); /* Shifting Secondary Accent */
            text-shadow: 0 0 5px var(--neon-secondary);
        }

        .toggle-btn {
            border: 1px solid var(--neon-primary); 
            color: var(--neon-primary); 
        }

        /* Sliders */
        input[type="range"]::-webkit-slider-thumb {
            background: var(--neon-primary); 
            box-shadow: 0 0 10px var(--neon-primary); 
        }
        /* Style for disabled slider to show it's locked */
        input[type="range"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .value-display {
            color: var(--neon-primary); 
        }

        /* Switches - All buttons now universally use color-shift style */
        .switches {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap; 
        }

        .switch-btn {
            flex: 1;
            min-width: 23%; 
            padding: 8px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #444;
            color: #888;
            cursor: pointer;
            font-size: 10px;
            text-transform: uppercase;
            transition: all 0.3s;
            text-align: center;
            /* Ensure the link inside the controls looks like a button */
            text-decoration: none; 
            display: block; 
            box-sizing: border-box; 
        }
        
        /* Universal Color Shift style */
        .switch-btn.active {
            animation: hueRotate 10s infinite linear;
            border: 2px solid;
            color: white;
            /* Dynamically set border color based on the primary hue */
            border-color: var(--neon-primary); 
            box-shadow: 0 0 10px var(--neon-primary);
        }
        
        /* Remove specific alert/blink animations to keep the requested pure shift */
        #alert-btn.active {
            /* Ensures ALERT button uses the primary shifting color now */
            border-color: var(--neon-primary) !important; 
            box-shadow: 0 0 10px var(--neon-primary) !important;
            animation: none; /* Disable previous fixed red glow */
        }
        
        @keyframes hueRotate {
            0% { 
                filter: hue-rotate(0deg); 
            }
            100% { 
                filter: hue-rotate(360deg); 
            }
        }

        /* Stats display top left */
        #hud-stats {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 5;
            pointer-events: none;
        }

        .stat-val {
            color: var(--neon-primary); /* Shifting color */
            font-weight: bold;
        }
        
        /* NEW: Top Right Links Container */
        #top-right-links {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }
        
        /* Styling for the R1ProgrammerSOF button in the top right */
        #r1prog-top-btn {
            padding: 10px 15px;
            background: rgba(0,0,0,0.6);
            border: 2px solid var(--neon-primary);
            color: white;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            text-decoration: none;
            border-radius: 4px;
            cursor: pointer;
            box-shadow: 0 0 15px var(--neon-primary);
            transition: all 0.3s;
            animation: hueRotate 10s infinite linear; /* Ensure the top button always glows and shifts */
        }
        
        #r1prog-top-btn:hover {
             box-shadow: 0 0 25px var(--neon-primary);
        }


        /* Side Monitor - DOUBLED SIZE: 250px -> 500px, 150px -> 300px */
        #side-monitor {
            position: absolute;
            top: 25%;
            left: 20px;
            width: 300px; /* Updated: Doubled from 250px */
            height:200px; /* Updated: Doubled from 150px */
            z-index: 5;
            /* Flexbox to stack elements vertically */
            display: flex; 
            flex-direction: column;
            justify-content: space-between;
            
            /* Border and shadow now use the shifting primary color */
            border: 5px solid var(--neon-dark); 
            background: var(--neon-dark);
            box-shadow: 0 0 15px var(--neon-dark), inset 0 0 20px hsla(var(--dynamic-h), 50%, 10%, 0.5);
            padding-bottom: 5px; /* Added slight padding for canvas */
        }

        #side-monitor h4 {
            background: var(--neon-dark);
            color: var(--neon-secondary);
            text-align: center;
            padding: 5px 10px;
            margin: 0;
            font-size: 10px;
        }

        /* Wave Canvas - HEIGHT DOUBLED: 100px -> 200px */
        #waveCanvas {
            width: 100%;
            height: 200px; /* Updated: Doubled from 100px */
            /* Added flex-grow so it uses remaining space */
            flex-grow: 1; 
        }
        
        /* Style for the link/button at the bottom of the side monitor */
        .monitor-footer-btn {
            display: block; /* Make the anchor tag behave like a block element */
            background: var(--neon-dark);
            border: 1px solid var(--neon-secondary);
            color: var(--neon-secondary);
            padding: 4px;
            margin: 5px; /* Adds margin around the link inside the monitor */
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            font-size: 8px;
            text-transform: uppercase;
            transition: all 0.2s;
            text-align: center;
            text-decoration: none; /* Remove underline from link */
        }

        /* Style for active/neon effect on the downloads link */
        .monitor-footer-btn.active {
            border-color: var(--neon-primary); 
            box-shadow: 0 0 5px var(--neon-primary);
            color: white;
            /* Using the hueRotate animation for extra visual effect */
            animation: hueRotate 5s infinite linear; 
        }


        /* Mobile Adjustments - DOUBLED SIZE: 150px -> 300px, 100px -> 200px */
        @media (max-width: 600px) {
            #side-monitor {
                width: 300px; /* Updated: Doubled from 150px */
                height: 200px; /* Updated: Doubled from 100px */
                top: 100px; /* Move it down below the HUD stats */
                left: 10px; 
            }
            
            #controls {
                width: calc(100% - 40px);
                right: 20px;
                bottom: 10px;
            }
            
            #top-right-links {
                top: 20px;
                right: 10px;
            }
            
            #r1prog-top-btn {
                font-size: 10px;
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>

    <div id="canvas-container">
        <canvas id="cyberCanvas"></canvas>
    </div>

    <!-- TOP RIGHT LINKS -->
    <div id="top-right-links">
         <a href="https://github.com/RSCompu/R1Programmer-Driver/releases/tag/R1Programmer" 
               target="_blank" 
               id="r1prog-top-btn" 
               title="R1ProgrammerSOF Link">
               R1ProgrammerSOF
            </a>
    </div>
    
    <!-- SIDE MONITOR -->
    <div id="side-monitor">
        <h4>R1ITLAB</h4>
        <canvas id="waveCanvas"></canvas>
        <!-- DOWNLOADS BUTTON remains in the monitor footer -->
        <a href="https://github.com/RSCompu?tab=repositories" target="_blank" 
           id="monitor-downloads-btn" class="monitor-footer-btn active">
            DOWNLOADS
        </a>
    </div>

    <div class="overlay"></div>
    <div class="scanlines"></div>

    <div id="hud-stats">
        <div class="stat-row">
            <span class="stat-label">SYSTEM:</span>
            <span class="stat-val">HYPER</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">MODE:</span>
            <span class="stat-val">SPECTRUM</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">TARGETS:</span>
            <span class="stat-val" id="target-count">0</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">HUE:</span>
            <!-- Threat level replaced with HUE counter, now shifts color -->
            <span class="stat-val" id="hue-level">298°</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">FPS:</span>
            <span class="stat-val" id="fps-counter">60</span>
        </div>
    </div>

    <div id="controls">
        <div class="control-header">
            <h3>SYS_CONFIG</h3>
            <button class="toggle-btn" id="minimize-btn">_</button>
        </div>

        <div class="control-group">
            <label>ROTATION SPEED</label>
            <div class="slider-container">
                <input type="range" id="speed-slider" min="0" max="200" value="200" disabled>
                <span class="value-display" id="speed-val">50%</span>
            </div>
        </div>

        <div class="control-group">
            <label>RADAR SWEEP</label>
            <div class="slider-container">
                <input type="range" id="radar-slider" min="0" max="100" value="100" disabled>
                <span class="value-display" id="radar-val">60%</span>
            </div>
        </div>

        <div class="control-group">
            <label>DATA DENSITY(LOCKED)</label>
            <div class="slider-container">
                <input type="range" id="data-slider" min="0" max="100" value="100" disabled>
                <span class="value-display" id="data-val">40%</span>
            </div>
        </div>

        <div class="control-group">
            <label>NEON GLOW (LOCKED)</label>
            <div class="slider-container">
                <!-- VALUE CHANGED TO 50 AND SLIDER IS DISABLED -->
                <input type="range" id="glow-slider" min="0" max="50" value="50" disabled>
                <span class="value-display" id="glow-val">50</span>
            </div>
        </div>

        <div class="switches">
            <!-- All buttons are now active and color-shifting -->
            <div class="switch-btn active" id="markers-btn">MARKERS</div>
            <div class="switch-btn active" id="alert-btn">DYNAMIC</div>
            <div class="switch-btn active" id="text-btn">DATA</div>
            <div class="switch-btn active" id="downloads-btn">SYSTEM</div>
            <div class="switch-btn active" id="spectrum-btn">HUE LOCK</div>
            
            <!-- R1ProgrammerSOF MOVED UP TO #top-right-links -->
        </div>
    </div>

    <script>
        // --- CONFIGURATION & STATE ---
        const canvas = document.getElementById('cyberCanvas');
        const ctx = canvas.getContext('2d');
        
        let width, height, centerX, centerY;
        let frames = 0;
        let lastTime = 0;
        
        const state = {
            rotationSpeed: 0.5,
            radarSpeed: 0.03,
            dataDensity: 0.4,
            glowIntensity: 50, // VALUE CHANGED TO 50 (MAX)
            showMarkers: true,
            showText: true,
            hueOffset: 298, // Start at Magenta
            hueLock: false, // NEW: State to lock the hue
            primaryColor: 'hsl(298, 99%, 53%)',
            secondaryColor: 'hsl(118, 100%, 50%)',
        };

        // Static colors for elements that should NOT shift (e.g., specific warning signs)
        const staticColors = {
            red: '#ff0055', 
            amber: '#ffbf00',
            black: '#0a0f14'
        };

        /**
         * Updates the global state colors based on the current hueOffset.
         * This function is called every frame to update CSS variables and JS state.
         */
        function updateDynamicColors() {
            // Apply hue shift
            const hue = state.hueLock ? state.hueOffset : (frames * 0.5) % 360;
            state.hueOffset = hue;
            
            // Primary color (e.g., Magenta base shifting)
            state.primaryColor = `hsl(${hue}, 99%, 53%)`;
            
            // Secondary color (180 degrees opposite on the wheel)
            const secondaryHue = (hue + 180) % 360;
            state.secondaryColor = `hsl(${secondaryHue}, 100%, 50%)`;

            // Update CSS variables for all UI elements
            document.documentElement.style.setProperty('--dynamic-h', hue);
            document.documentElement.style.setProperty('--dynamic-s', '99%');
            document.documentElement.style.setProperty('--dynamic-l', '53%');
            document.documentElement.style.setProperty('--neon-dark', `hsl(${hue}, 50%, 10%)`);

            // Update HUD counter
            const hueEl = document.getElementById('hue-level');
            if (hueEl) {
                hueEl.textContent = `${Math.round(hue)}°`;
                hueEl.style.color = state.primaryColor;
            }
        }


        // --- ENTITIES ---

        // 1. Rings
        class Ring {
            constructor(radius, speed, width, type) {
                this.radius = radius;
                this.baseSpeed = speed;
                this.width = width;
                this.type = type; // 'solid', 'dashed', 'segmented', 'ticks'
                this.angle = Math.random() * Math.PI * 2;
                this.isSecondary = Math.random() > 0.7;
            }

            update() {
                this.angle += this.baseSpeed * state.rotationSpeed * 0.02;
            }

            draw() {
                ctx.beginPath();
                
                // Rings shift between primary and secondary shifting colors
                const drawColor = this.isSecondary ? state.secondaryColor : state.primaryColor;

                ctx.strokeStyle = drawColor;
                ctx.lineWidth = this.width;
                ctx.shadowBlur = state.glowIntensity;
                ctx.shadowColor = drawColor;

                if (this.type === 'solid') {
                    ctx.arc(centerX, centerY, this.radius, 0, Math.PI * 2);
                    ctx.stroke();
                } 
                else if (this.type === 'dashed') {
                    ctx.setLineDash([10, 20]);
                    ctx.arc(centerX, centerY, this.radius, this.angle, this.angle + Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
                else if (this.type === 'segmented') {
                    const segments = 6;
                    const gap = 0.2;
                    const segLen = (Math.PI * 2) / segments - gap;
                    
                    for(let i=0; i<segments; i++) {
                        let start = this.angle + i * (segLen + gap);
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, this.radius, start, start + segLen);
                        ctx.stroke();
                    }
                }
                else if (this.type === 'ticks') {
                    const ticks = 40;
                    for(let i=0; i<ticks; i++) {
                        const a = this.angle + (i / ticks) * Math.PI * 2;
                        const x1 = centerX + Math.cos(a) * this.radius;
                        // FIX: Declare y1 and y2 with 'let'
                        let y1 = centerY + Math.sin(a) * this.radius;
                        const x2 = centerX + Math.cos(a) * (this.radius + 10);
                        let y2 = centerY + Math.sin(a) * (this.radius + 10);
                        ctx.beginPath();
                        ctx.moveTo(x1, y1);
                        ctx.lineTo(x2, y2);
                        ctx.stroke();
                    }
                }
            }
        }

        // 2. Map Points / Crime Markers
        class Marker {
            constructor() {
                this.reset();
            }

            reset() {
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.random() * (Math.min(width, height) * 0.25); 
                this.x = centerX + Math.cos(angle) * dist;
                this.y = centerY + Math.sin(angle) * dist;
                this.life = 0;
                this.maxLife = 100 + Math.random() * 100;
                this.type = Math.random() > 0.7 ? 'crime' : (Math.random() > 0.5 ? 'police' : 'event');
            }

            update() {
                if(!state.showMarkers) return;
                this.life++;
                if (this.life > this.maxLife) {
                    this.reset();
                }
            }

            draw() {
                if(!state.showMarkers) return;
                
                let color = state.primaryColor; // Markers default to the primary shifting color
                let size = 3;
                
                // Sub-types can use static colors or shift
                if (this.type === 'crime') {
                    color = staticColors.red; // Keep red for specific urgency
                } else if (this.type === 'police') {
                    color = state.secondaryColor;
                } 

                // Blink effect
                const opacity = Math.abs(Math.sin(this.life * 0.05));
                
                ctx.globalAlpha = opacity;
                ctx.fillStyle = color;
                ctx.shadowBlur = state.glowIntensity / 2;
                ctx.shadowColor = color;
                
                // Draw dot
                ctx.beginPath();
                ctx.arc(this.x, this.y, size, 0, Math.PI * 2);
                ctx.fill();

                // Draw expanding ring occasionally
                if (this.life % 40 < 20) {
                    ctx.beginPath();
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1;
                    ctx.arc(this.x, this.y, size + (this.life % 20), 0, Math.PI * 2);
                    ctx.stroke();
                }

                ctx.globalAlpha = 1;
            }
        }

        // 3. Data Streams
        class DataStream {
            constructor() {
                this.reset();
            }
            
            reset() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.speed = Math.random() * 2 + 1;
                this.chars = "01XYZ789ABCDEF".split('');
                this.text = "";
                this.updateText();
                this.opacity = Math.random() * 0.5 + 0.1;
                
                // Data streams randomly choose between primary and secondary shifting colors
                this.colorIndex = Math.random() > 0.5 ? 0 : 1; 
            }

            updateText() {
                let len = Math.floor(Math.random() * 5) + 3;
                this.text = "";
                for(let i=0; i<len; i++) {
                    this.text += this.chars[Math.floor(Math.random() * this.chars.length)];
                }
            }

            update() {
                this.y += this.speed * (state.rotationSpeed + 0.5); 
                if (this.y > height) this.y = -50;
                
                if (Math.random() < 0.05) this.updateText();
            }

            draw() {
                if (!state.showText) return;
                
                const drawColor = this.colorIndex === 0 ? state.primaryColor : state.secondaryColor;

                ctx.fillStyle = drawColor;
                ctx.globalAlpha = this.opacity * state.dataDensity; 
                ctx.font = '10px monospace';
                ctx.fillText(this.text, this.x, this.y);
                ctx.globalAlpha = 1;
            }
        }

        // --- SIDE MONITOR WAVEFORM ---
        let waveCtx, waveWidth, waveHeight;
        function initWaveform() {
            const waveCanvas = document.getElementById('waveCanvas');
            if (!waveCanvas) return; 
            
            waveCtx = waveCanvas.getContext('2d');
            
            // Get dimensions from the CSS-defined size of the canvas element
            const rect = waveCanvas.getBoundingClientRect();
            waveCanvas.width = rect.width;
            waveCanvas.height = rect.height;
            waveWidth = rect.width;
            waveHeight = rect.height;
        }

        function drawWaveform(time) {
            if(!waveCtx || waveWidth === 0 || waveHeight === 0) return;
            
            // Clear side monitor canvas (dark fading effect)
            waveCtx.fillStyle = 'hsla(' + state.hueOffset + ', 50%, 10%, 0.2)'; 
            waveCtx.fillRect(0, 0, waveWidth, waveHeight);
            
            waveCtx.beginPath();
            
            // Waveform color is the secondary shifting color
            waveCtx.strokeStyle = state.secondaryColor;
            waveCtx.lineWidth = 2;
            waveCtx.shadowBlur = 5;
            waveCtx.shadowColor = state.secondaryColor; // Use waveCtx for shadow

            const freq = 0.05;
            const amp = 40; 
            const speed = time * 0.1;

            for(let x = 0; x < waveWidth; x+=2) {
                const y = waveHeight/2 + 
                          Math.sin(x * freq + speed) * amp + 
                          Math.sin(x * 0.02 - speed * 1.5) * (amp/2);
                
                if(x===0) waveCtx.moveTo(x, y);
                else waveCtx.lineTo(x, y);
            }
            waveCtx.stroke();
            waveCtx.shadowBlur = 0; // Reset shadow after drawing
        }

        // --- INIT & MAIN LOOP ---

        const rings = [];
        const markers = [];
        const streams = [];
        let radarAngle = 0;

        function init() {
            resize();
            window.addEventListener('resize', resize);
            
            // Create Rings
            const minDim = Math.min(width, height);
            rings.push(new Ring(minDim * 0.08, 0.5, 2, 'solid'));
            rings.push(new Ring(minDim * 0.12, -0.3, 1, 'segmented'));
            rings.push(new Ring(minDim * 0.18, 0.2, 4, 'dashed'));
            rings.push(new Ring(minDim * 0.20, -0.4, 1, 'ticks')); 
            rings.push(new Ring(minDim * 0.25, 0.1, 1, 'solid'));
            rings.push(new Ring(minDim * 0.32, -0.1, 8, 'solid')); // Thicker glass ring
            rings.push(new Ring(minDim * 0.33, -0.2, 2, 'dashed'));
            rings.push(new Ring(minDim * 0.40, 0.05, 1, 'segmented'));

            // Create Markers
            for(let i=0; i<15; i++) {
                markers.push(new Marker());
            }

            // Create Data Streams
            for(let i=0; i<50; i++) {
                streams.push(new DataStream());
            }

            setupEventListeners();
            initWaveform(); 
            setupMonitorDrag();
            requestAnimationFrame(animate);
        }

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            centerX = width / 2;
            centerY = height / 2;
            // Re-initialize waveform canvas size on resize
            initWaveform();
        }

        function setupMonitorDrag() {
            const monitor = document.getElementById('side-monitor');
            const header = monitor.querySelector('h4');
            
            let isDragging = false;
            let xOffset = 0;
            let yOffset = 0;

            header.addEventListener("mousedown", dragStart);
            document.addEventListener("mouseup", dragEnd);
            document.addEventListener("mousemove", drag);
            
            header.addEventListener("touchstart", (e) => { e.preventDefault(); dragStart(e.touches[0]); });
            document.addEventListener("touchend", dragEnd);
            document.addEventListener("touchmove", (e) => { e.preventDefault(); drag(e.touches[0]); });

            function dragStart(e) {
                const rect = monitor.getBoundingClientRect();
                xOffset = e.clientX - rect.left;
                yOffset = e.clientY - rect.top;

                isDragging = true;
                monitor.style.transform = "none"; 
                monitor.style.animation = "none";
                monitor.style.opacity = "1";
            }

            function dragEnd(e) {
                isDragging = false;
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();
                    
                    let currentX = e.clientX - xOffset;
                    let currentY = e.clientY - yOffset;

                    const bounds = {
                        maxX: window.innerWidth - monitor.offsetWidth,
                        maxY: window.innerHeight - monitor.offsetHeight
                    };

                    currentX = Math.min(Math.max(0, currentX), bounds.maxX);
                    currentY = Math.min(Math.max(0, currentY), bounds.maxY);

                    monitor.style.left = currentX + "px";
                    monitor.style.top = currentY + "px";
                }
            }
        }

        function setupEventListeners() {
            // Sliders
            document.getElementById('speed-slider').addEventListener('input', (e) => {
                state.rotationSpeed = e.target.value / 100;
                document.getElementById('speed-val').textContent = e.target.value + '%';
            });
            document.getElementById('radar-slider').addEventListener('input', (e) => {
                state.radarSpeed = e.target.value / 2000;
                document.getElementById('radar-val').textContent = e.target.value + '%';
            });
            document.getElementById('data-slider').addEventListener('input', (e) => {
                state.dataDensity = e.target.value / 100;
                document.getElementById('data-val').textContent = e.target.value + '%';
            });
            
            // Toggles
            document.getElementById('markers-btn').addEventListener('click', (e) => {
                state.showMarkers = !state.showMarkers;
                e.target.classList.toggle('active', state.showMarkers);
            });
            
            document.getElementById('text-btn').addEventListener('click', (e) => {
                state.showText = !state.showText;
                e.target.classList.toggle('active', state.showText);
            });
            
            // HUE LOCK BUTTON: Toggles hueLock state
            document.getElementById('spectrum-btn').addEventListener('click', (e) => {
                state.hueLock = !state.hueLock;
                e.target.textContent = state.hueLock ? 'HUE UNLOCK' : 'HUE LOCK';
                e.target.classList.toggle('active', !state.hueLock); 

                if (state.hueLock) {
                    // Lock the current hue
                    state.hueOffset = (frames * 0.5) % 360; 
                }
            });

            // ALERT button renamed to DYNAMIC and simply toggles the active state
            document.getElementById('alert-btn').addEventListener('click', (e) => {
                e.target.classList.toggle('active');
            });
            
            // Minimize
            const controls = document.getElementById('controls');
            document.getElementById('minimize-btn').addEventListener('click', () => {
                controls.classList.toggle('collapsed');
            });
        }

        function drawGrid() {
            ctx.save();
            ctx.translate(centerX, centerY);
            
            // Grid lines use a very subtle, transparent shifting color
            const gridColor = state.primaryColor.replace(')', ', 0.15)').replace('hsl', 'hsla');
            
            ctx.strokeStyle = gridColor;
            ctx.lineWidth = 1;
            
            // Radial lines
            for(let i=0; i<12; i++) {
                ctx.beginPath();
                ctx.moveTo(0,0);
                const a = (i/12) * Math.PI * 2 + (frames * 0.001 * state.rotationSpeed);
                ctx.lineTo(Math.cos(a)*height, Math.sin(a)*height);
                ctx.stroke();
            }

            ctx.restore();
        }

        function drawRadar() {
            const radius = Math.min(width, height) * 0.35;
            
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(radarAngle);
            
            // Radar Sweep Gradient (Uses the secondary shifting color)
            const grad = ctx.createConicGradient(0, 0, 0);
            const sweepColor = state.secondaryColor;
            
            grad.addColorStop(0, 'rgba(0,0,0,0)');
            grad.addColorStop(0.8, 'rgba(0,0,0,0)');
            grad.addColorStop(1, sweepColor); 
            
            ctx.fillStyle = grad;
            ctx.globalAlpha = 0.2;
            ctx.beginPath();
            ctx.arc(0, 0, radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Leading edge line
            ctx.beginPath();
            ctx.moveTo(0,0);
            ctx.lineTo(radius, 0);
            ctx.strokeStyle = sweepColor;
            ctx.lineWidth = 2;
            ctx.globalAlpha = 1;
            ctx.shadowBlur = 10;
            ctx.shadowColor = sweepColor;
            ctx.stroke();

            ctx.restore();
        }

        function animate(timestamp) {
            // Update Colors based on hueLock state
            updateDynamicColors();
            
            // FPS Calc
            const delta = timestamp - lastTime;
            lastTime = timestamp;
            if (frames % 20 === 0) {
                document.getElementById('fps-counter').innerText = Math.round(1000/delta);
            }
            frames++;

            // Clear Main Canvas
            ctx.fillStyle = staticColors.black;
            ctx.fillRect(0, 0, width, height);

            // Draw Side Monitor Wave
            drawWaveform(frames);

            // Background Data Streams
            streams.forEach(s => {
                s.update();
                s.draw();
            });

            // Grid Map
            drawGrid();

            // Rings
            rings.forEach(ring => {
                ring.update();
                ring.draw();
            });

            // Radar
            radarAngle += state.radarSpeed;
            drawRadar();

            // Markers
            let visibleMarkers = 0;
            markers.forEach(marker => {
                marker.update();
                marker.draw();
                if(marker.life < marker.maxLife) visibleMarkers++;
            });
            
            if (frames % 10 === 0) {
               document.getElementById('target-count').innerText = visibleMarkers;
            }

            // Central Crosshair
            // Crosshair also shifts color
            ctx.strokeStyle = state.primaryColor;
            ctx.lineWidth = 1;
            ctx.shadowBlur = state.glowIntensity / 2;
            ctx.shadowColor = state.primaryColor;
            ctx.beginPath();
            ctx.moveTo(centerX - 10, centerY);
            ctx.lineTo(centerX + 10, centerY);
            ctx.moveTo(centerX, centerY - 10);
            ctx.lineTo(centerX, centerY + 10);
            ctx.stroke();
            ctx.shadowBlur = 0;


            requestAnimationFrame(animate);
        }

        window.onload = init;

    </script>
</body>
</html>

